<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>High-Fidelity AR Project</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

    <script>
      AFRAME.registerComponent("gesture-handler", {
        schema: {
          enabled: { default: true },
          rotationFactor: { default: 5 },
          minScale: { default: 0.3 },
          maxScale: { default: 8 },
        },
        init: function () {
          this.handleScale = this.handleScale.bind(this);
          this.handleRotation = this.handleRotation.bind(this);
          this.isVisible = false;
          this.initialScale = this.el.object3D.scale.clone();
          this.scaleFactor = 1;
          this.el.sceneEl.addEventListener("markerFound", (e) => { this.isVisible = true; });
          this.el.sceneEl.addEventListener("markerLost", (e) => { this.isVisible = false; });
        },
        update: function () {
          if (this.data.enabled) {
            this.el.sceneEl.addEventListener("onefingermove", this.handleRotation);
            this.el.sceneEl.addEventListener("twofingermove", this.handleScale);
          } else {
            this.el.sceneEl.removeEventListener("onefingermove", this.handleRotation);
            this.el.sceneEl.removeEventListener("twofingermove", this.handleScale);
          }
        },
        handleRotation: function (event) {
          if (this.isVisible) {
            this.el.object3D.rotation.y += event.detail.positionChange.x * this.data.rotationFactor;
            this.el.object3D.rotation.x += event.detail.positionChange.y * this.data.rotationFactor;
          }
        },
        handleScale: function (event) {
          if (this.isVisible) {
            this.scaleFactor *= 1 + event.detail.spreadChange / event.detail.startSpread;
            this.scaleFactor = Math.min(Math.max(this.scaleFactor, this.data.minScale), this.data.maxScale);
            this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
            this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
            this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
          }
        },
      });

      // Component to detect gesture events
      AFRAME.registerComponent("gesture-detector", {
        init: function () {
          this.targetElement = this.el;
          this.prevUseState = false;
          this.currentState = false;
          this.handleTouch(this.targetElement);
        },
        handleTouch: function (e) {
          e.addEventListener("touchstart", (t) => { this.currentState = true; this.emitGesture(t); });
          e.addEventListener("touchend", (t) => { this.currentState = false; this.emitGesture(t); });
          e.addEventListener("touchmove", (t) => { this.emitGesture(t); });
        },
        emitGesture: function (e) {
          if (e.touches.length === 2) { this.el.emit("twofingermove", { positionChange: { x: 0, y: 0 }, spreadChange: this.getSpread(e.touches) - this.startSpread, startSpread: this.startSpread }); }
          if (e.touches.length === 1) { this.el.emit("onefingermove", { positionChange: { x: e.touches[0].pageX - this.startX, y: e.touches[0].pageY - this.startY } }); }
          if (e.touches.length < 2) { this.startSpread = 0; }
          if (e.touches.length === 1) { this.startX = e.touches[0].pageX; this.startY = e.touches[0].pageY; }
          if (e.touches.length === 2 && this.startSpread === 0) { this.startSpread = this.getSpread(e.touches); }
        },
        getSpread: function (t) { return Math.hypot(t[0].pageX - t[1].pageX, t[0].pageY - t[1].pageY); },
      });
    </script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene mindar-image="imageTargetSrc: ./assets/targets.mind; autoStart: true; filterMinCF: 0.0001; filterBeta: 0.001;" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false"
             gesture-detector>
      
      <a-assets>
        <a-asset-item id="awesome-model" src="./assets/solar_system_animation.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      <a-entity light="type: directional; intensity: 0.8;" position="1 1 1"></a-entity>
      <a-entity light="type: ambient; intensity: 0.5;"></a-entity>

      <a-entity mindar-image-target="targetIndex: 0">
        
        <a-gltf-model src="#awesome-model" 
                      rotation="0 0 0" 
                      position="0 0 0" 
                      scale="0.5 0.5 0.5"
                      gesture-handler
                      animation-mixer>
        </a-gltf-model>

      </a-entity>
    </a-scene>
  </body>
</html>
